import numpy as np
import matplotlib.pyplot as plt
from matplotlib.colors import hsv_to_rgb


PLOT_CONFIG = {
    "label_size": 26,
    "legend_size": 24
}


def setup():
    plt.style.use('default')
    plt.rcParams['axes.labelsize'] = PLOT_CONFIG["label_size"]
    plt.rcParams['legend.fontsize'] = PLOT_CONFIG["legend_size"]
    plt.rcParams.update({
        "text.usetex": True,
        "font.family": "serif",
        "text.latex.preamble": r"\usepackage{times}",
    })


def plot_stability_gap(save_as):
    setup()
    raw_data, v_line = __get_data()
    performance = box_filter(raw_data, 11)

    cl = (0, 0, 0, 0.25)
    line_cl = hsv_to_rgb((0.956, 0.878, 1.0))
    v_label = "Task switch"
    x_lim = (120, 380)
    y_lim = (75, 100)

    plt.plot(performance, label="Accuracy", linewidth=5, color=line_cl)
    plt.axvline(x=v_line, ls=":", label=v_label, color=cl, linewidth=5, zorder=0)

    plt.xticks([])
    plt.yticks([])
    plt.xlabel("Time")
    plt.ylabel("Model performance")

    plt.gca().spines[['right', 'top']].set_visible(False)

    plt.xlim(x_lim)
    plt.ylim(y_lim)

    legend = plt.legend(loc="lower right", frameon=False)
    legend.get_frame().set_facecolor((1, 1, 1))

    fig = plt.gcf()
    fig.set_size_inches(8, 5)

    plt.tight_layout()
    plt.savefig(save_as)
    # plot_all_tasks_for_experiment(2, results, ylim=(0, 100), show_std=False, plots_dir=plots_dir, should_show=False)


def box_filter(arr, size=3):
    if size <= 0: raise ValueError("Size must be 1 or larger")
    if size % 2 == 0: raise ValueError("Size must be odd")

    kernel = np.full((size, ), 1/size)
    return np.convolve(arr, kernel, mode='same')


def __get_data():
    return (__raw_data(), 200)


def __raw_data():
    return [
        9.5703125, 21.58203125, 23.53515625, 33.30078125, 18.75,
        37.5, 49.21875, 55.2734375, 53.90625, 60.25390625,
        66.9921875, 72.75390625, 77.83203125, 80.078125, 84.27734375,
        84.1796875, 86.62109375, 87.59765625, 89.94140625, 90.91796875,
        90.0390625, 90.625, 90.4296875, 89.74609375, 91.40625,
        89.0625, 90.91796875, 92.96875, 92.3828125, 92.3828125,
        92.67578125, 91.40625, 92.67578125, 93.359375, 93.9453125,
        92.578125, 93.1640625, 93.26171875, 93.65234375, 91.89453125,
        91.89453125, 92.67578125, 94.53125, 92.578125, 93.75,
        91.9921875, 93.06640625, 94.04296875, 93.75, 93.75,
        93.65234375, 93.1640625, 93.26171875, 93.84765625, 94.3359375, 94.3359375,
        93.45703125, 94.140625, 95.3125, 95.3125, 94.921875,
        92.87109375, 94.921875, 95.3125, 95.99609375, 95.41015625,
        94.140625, 93.75, 95.703125, 96.09375, 95.1171875,
        94.62890625, 96.875, 95.5078125, 95.3125, 95.60546875,
        95.99609375, 95.3125, 94.82421875, 95.21484375, 95.1171875,
        95.80078125, 94.82421875, 95.3125, 95.41015625, 96.38671875,
        95.1171875, 94.62890625, 95.01953125, 95.41015625, 95.80078125,
        96.484375, 95.1171875, 95.5078125, 96.09375, 96.484375,
        95.80078125, 96.875, 94.7265625, 96.58203125, 94.921875,
        95.80078125, 96.09375, 96.19140625, 96.2890625, 94.921875,
        95.8984375, 95.8984375, 96.6796875, 95.80078125, 96.19140625,
        95.8984375, 96.09375, 94.7265625, 96.58203125, 96.484375, 96.484375,
        96.77734375, 96.09375, 96.38671875, 95.99609375, 95.99609375,
        95.3125, 94.82421875, 96.09375, 95.60546875, 96.09375,
        95.60546875, 96.09375, 96.77734375, 96.38671875, 95.8984375,
        95.703125, 94.82421875, 95.8984375, 95.703125, 96.58203125,
        96.58203125, 96.38671875, 95.8984375, 96.2890625, 96.484375,
        96.77734375, 95.3125, 96.19140625, 96.58203125, 95.80078125,
        96.09375, 96.38671875, 95.99609375, 96.875, 96.97265625,
        96.77734375, 96.77734375, 97.36328125, 95.99609375, 96.2890625,
        97.36328125, 96.38671875, 96.09375, 94.3359375, 96.09375,
        97.75390625, 96.484375, 96.6796875, 95.60546875, 95.703125,
        95.80078125, 96.09375, 94.921875, 96.09375, 95.80078125,
        95.99609375, 96.09375, 95.80078125, 96.09375, 96.484375,
        95.8984375, 96.58203125, 96.38671875, 96.19140625, 95.21484375,
        96.38671875, 96.2890625, 96.38671875, 96.77734375, 94.7265625,
        95.41015625, 96.97265625, 96.77734375, 96.19140625, 96.77734375,
        97.16796875, 96.97265625, 96.6796875, 96.484375, 96.875,
        96.97265625, 96.484375, 96.58203125, 97.36328125, 94.7265625,
        84.86328125, 81.005859375, 76.5625, 76.3671875, 77.783203125,
        78.271484375, 80.46875, 82.568359375, 83.349609375, 87.353515625,
        88.720703125, 89.55078125, 91.11328125, 90.4296875, 92.138671875,
        90.869140625, 91.6015625, 91.845703125, 92.333984375, 93.310546875,
        93.017578125, 93.408203125, 93.994140625, 93.75, 93.701171875,
        94.873046875, 94.287109375, 93.603515625, 94.873046875, 94.82421875,
        94.482421875, 94.23828125, 95.01953125, 94.43359375, 94.873046875,
        93.994140625, 94.7265625, 95.361328125, 95.1171875, 95.166015625,
        95.8984375, 95.3125, 95.263671875, 94.482421875, 94.580078125,
        95.3125, 96.38671875, 95.60546875, 95.849609375, 95.068359375,
        95.99609375, 95.068359375, 95.458984375, 96.240234375, 96.044921875,
        95.80078125, 95.947265625, 95.8984375, 96.19140625, 96.09375,
        96.337890625, 95.99609375, 95.99609375, 95.947265625, 95.751953125,
        96.09375, 95.263671875, 96.923828125, 95.80078125, 96.38671875,
        96.19140625, 96.240234375, 96.826171875, 96.38671875, 95.99609375,
        96.19140625, 96.337890625, 96.240234375, 95.703125, 96.630859375,
        96.728515625, 96.337890625, 96.044921875, 96.435546875, 95.654296875,
        96.142578125, 95.80078125, 96.58203125, 96.19140625, 97.119140625,
        96.435546875, 96.826171875, 96.19140625, 96.337890625, 95.458984375,
        95.5078125, 96.38671875, 96.337890625, 95.8984375, 96.97265625,
        96.630859375, 96.77734375, 95.80078125, 96.2890625, 96.38671875,
        96.337890625, 97.119140625, 96.044921875, 96.77734375, 96.337890625,
        96.58203125, 95.5078125, 96.240234375, 96.630859375, 97.36328125,
        96.58203125, 96.875, 97.0703125, 96.337890625, 96.142578125,
        97.16796875, 95.751953125, 96.630859375, 96.58203125, 95.80078125,
        96.923828125, 96.533203125, 96.2890625, 96.19140625, 96.826171875,
        96.337890625, 96.6796875, 96.630859375, 96.6796875, 96.58203125,
        96.533203125, 95.8984375, 96.630859375, 96.97265625, 97.216796875,
        96.484375, 95.703125, 96.826171875, 96.2890625, 97.36328125,
        96.6796875, 95.80078125, 97.0703125, 96.875, 97.021484375,
        96.77734375, 97.509765625, 96.923828125, 97.412109375, 96.58203125,
        96.435546875, 96.630859375, 96.533203125, 96.826171875, 97.0703125,
        96.533203125, 97.314453125, 96.6796875, 96.533203125, 97.021484375,
        96.923828125, 96.826171875, 97.0703125, 96.875, 96.38671875,
        96.875, 96.875, 96.630859375, 97.119140625, 96.77734375,
        96.728515625, 96.58203125, 96.630859375, 97.314453125, 97.0703125,
        96.435546875, 96.77734375, 97.36328125, 97.314453125, 97.16796875,
        96.142578125, 96.875, 97.16796875, 96.97265625, 97.509765625,
        97.021484375, 97.119140625, 97.021484375, 97.607421875, 96.58203125,
        97.802734375, 97.216796875, 97.314453125
    ]